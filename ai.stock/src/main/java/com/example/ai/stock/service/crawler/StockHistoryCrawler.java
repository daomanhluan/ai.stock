package com.example.ai.stock.service.crawler;

import com.example.ai.stock.aggregate.stock.model.StockCategory;
import com.example.ai.stock.aggregate.stock.model.StockHistory;
import com.example.ai.stock.configuration.constant.StockConstant;
import com.example.ai.stock.infrastruture.entity.StockCategoryEntity;
import com.example.ai.stock.infrastruture.entity.StockHistoryEntity;
import com.example.ai.stock.infrastruture.repository.StockCategoryRepository;
import com.example.ai.stock.infrastruture.repository.StockHistoryRepository;
import com.example.ai.stock.service.filter.StockFilter;
import com.example.ai.stock.service.utils.MapperUtils;
import com.example.ai.stock.service.utils.ModelMapperUtils;
import com.google.common.collect.Lists;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.Set;

@Service
@RequiredArgsConstructor
@Slf4j
public class StockHistoryCrawler implements CrawlerData {

  private final Integer TOTAL_PAGE = 100;
  private final StockFilter stockFilter;
  private final StockHistoryRepository stockHistoryRepository;
  private final StockCategoryRepository stockCategoryRepository;
  @Value("${cafef-host-lich-su-gia}")
  private String URL_API;

//  "SSI","NKG"

//  @EventListener(ApplicationReadyEvent.class)
  @Override
  public void crawl() throws InterruptedException {

    List<StockCategoryEntity> stockCategoryEntities = stockCategoryRepository.findAll();
    for (StockCategoryEntity stockCategoryEntity : stockCategoryEntities) {
      if(!StockConstant.CHUNG_KHOAN.contains(stockCategoryEntity.getCode())) continue;

      String stockCode = stockCategoryEntity.getCode();
      List<StockHistory> stockHistories =
          getStockHistory(stockCode, URL_API + stockCode.toLowerCase() + ".chn");
      saveDB(stockHistories);

      Thread.sleep(100);
    }
    System.out.println("=====================================DONE=====================================");
  }

  private void saveDB(List<StockHistory> stockHistories) {
    List<List<StockHistory>> allStockHistories = Lists.partition(stockHistories, 500);
    for (List<StockHistory> partion : allStockHistories) {
      stockHistoryRepository.saveAll(ModelMapperUtils.mapList(partion, StockHistoryEntity.class));
    }
  }

  private List<StockHistory> getStockHistory(String code, String url){
    System.out.println("url=="+url);
    String request =
        "ctl00%24ContentPlaceHolder1%24scriptmanager=ctl00%24ContentPlaceHolder1%24ctl03%24panelAjax%7Cctl00%24ContentPlaceHolder1%24ctl03%24pager2&ctl00%24ContentPlaceHolder1%24ctl03%24txtKeyword={STOCK_CODE}&ctl00%24ContentPlaceHolder1%24ctl03%24dpkTradeDate1%24txtDatePicker=&ctl00%24ContentPlaceHolder1%24ctl03%24dpkTradeDate2%24txtDatePicker=&__VIEWSTATE=rrrtcZK7ylHXKXlpTL17oV4MPisIBWkfQ5AM4sZp1bJVy73Ibem0ffNIjjj2DFe%2FfhqsXbRkVbFa9aD73q6%2FuzOGS0fYQR6WXIqNcG7YT7BlzL37snyWyG5MuPbu3a6WI3izLhg%2B65GqT7%2Bz2axaii3BOHfxITRwEm10dE47cORniM1cZOSpG44OtuUI3TeP1P8aBN55MI2Utmn%2Fi%2Ft3gY75PQAzQIm1EOcr7jA56QF2e3Zz%2BIN3dQNDKmx4fMDTh3Jo2X90ii8sBCKuVlhUgFI5ZpYP%2FVOxt79%2FMQQ%2BxmQQnlFy5Dy%2BBJcnQIS6hcp08LpI7NQAh25mzByy6SKE2lhi%2FleCWFvkiirdzeNZB8%2B17d%2BW23saL5VU1MmJinEz6%2F1ivO6kBDILZHMPDCZQwLqsnWqTplglgCOZbaLau6oWfsrWX%2BnHXvzLR5Z2%2FJ0eGcIlSowlngx4Lq48qAwSC2CdZfviFUTsJRsQxZJY6jhTkjWcXkIFiFSZVvZnK6sV47v3xEXleO%2BgfOmKiKjOWBxmdj4x19Ur7m%2FtEBkXmbvEN89OtSaGvhJSSnVaspj81ZAx06iF5KJkSPT93xwENH4WwU1VaLF7D5cWcy3IXti6mEZNhpdFwGW2KGLOVPgTw4V2YtncQGFi87dj%2F9VgKofw12RlMSj%2B%2FSDEgBJyIObBnidvgxvRqa%2FoqnJo6dQjzmsgm3U7rnx5vvMDkqC4pNdWzNXMyMwCa0MMNw1heMfTJYXAYkl%2BfIaISfvLP5GQkkrc3MlHgAqfji2zhZ5JmKsamCC2VdpX2cR8Pt7%2FnebXBDzg%2FuWnSGJ2ntJP77slPjgMtWnIamA%2Foox%2BVFFWlbJbhypRfKAUEJBfqHt921G6Y2Vikiz3i7Q53riV4JS5GA8nZEq5kwMIfedKZZYg7q%2FHSoWbPjCYJ5tSuRW%2BfgLhKuFV%2BP%2BsWNWgxjbMcGec4Nzn5Tocsk%2BcV9q1qsUf2Ao3bCEYwcrYzHxacFAyjmPZTnxh4I5A0rEz5JYrBqTVssKNwtFb9cc2Zv7X98SedkM76wyfVc2NKSA6xiBhhWdZdRk9Vru74%2BQ2zKXiky3v9B53t9VWUdElecTsuSYbFlVbrhAvOdSraP%2F9Oh4Cl6s%2FBaekP9F6z4t70e0%2Fe14bsJr%2FvRgQRetTpyMIOi9FFfthvy4baqChQ7zG5cxewtQAJaRM2U1DjFns4tFfeK1v7mMunwYV879WACdSOefCCB2QONn3xVsjS3Qw3ZiKBhpHFme%2BMMbqhOGYWWYfHkM2ccI%2Bt6DGSS7PSaH%2B2ZQ8W593xUHhRFtot3n8lboGj5Sj0QgI%2F%2FThYPv93ypJcT8xxWtl6pNt79R3WPUynjYRlX1f5%2B6isI1h7VcG0H5n1EU82DNfMHh1vo04bTGviHDO0pkfIHILelgD%2F5BtgrR%2B56C8mqBoxY3MVrCqL0Fsyd%2Beu1zWqUOT7lvHo1%2Fp1%2FRwwNZ4Mq%2FLmTpxQhGsVY36ZEp3AQROjP0JxEKjJwzzhCxoLrHG%2FZXBKoHbW4%2FIfigpcriGHB%2FXx7ZbHjTvosA9YegE8kvWWt3UTJ8qP05A7UiAUTpOc1r8oLRQDvkVqpepH%2FP%2BZGUQXuChk2MHgi9bzPUgbiV5pwEGZ4DpI6c9vJs63naTaWQeeZZzaIHyTLs4kHIffL1l9rxC9eP%2B3kpySlb14%2B0S1WYDR%2F5nJ6nHFk%2BRLqVN%2B7MkGXSikvGFp3c4yQ4dorNUy3wq85UnaRf98alaOaEz3U9uX1%2F8Qy8iDcjLFLhoNETkl5lWkhfw8zH9oXeUJfJwO%2Ft7b2htaEEcglQP9yJ8YX4zlG5FIkgEqNVMevkAqokCTwOF9HRiHbjDGUZBlsiG47M3po8p4jsQELFHyRAmlFhVIFrznEwTyuTEP4uyTP04bIoJkCJhZOVad%2B3BglJsGwUxw7J5qA0kT2bSxmyddB%2B%2FVXkYzuurpo%2BeudSurNxOoCP0XUL1cljc1Nq7cG%2FLLZrQOKNXYF1PBPNVa2JWv%2B9ijoJMalXqWCQZkB6AJG%2B1pRpSdDmy4zvTXFeymFb%2F2ATk28CBVUvk0%2Ban3HarYexEMULprh4%2BZ0CxEFbb3olbHXwMYf%2B9X0j5USHW9ILkHniSAlij5hI3SSeAnUKw%2F9C3t3FAi1zeZN7lgowPn57ucblILoWjpDV9AksMCcwBVKaQA1AyCWa8HtKLm8DjofRM5K6bKeqggQnjdPGCwu1DsQnDhVMRROoZt%2Fp5xj61Crc885wuAirWPxOKyvuCY%2BvrZsc9u3nuC%2FOgO%2BoNRYz2S%2BVN952Cti14xlwVccSJQL44XyPG2x4D8puyki%2BLiYPI3UFV34sJt6NOQZj4sOuVkBIzEaFrua6yEq0oAWJNSLTfl3Yy%2FGJfh1dknI7I8zUwQJu3wZRH3%2FtyBG4z390wYPvupFqv5tRxCnsRO6s%2BhA7kUs419JTDNCgFEdyLnR34LuvGjLl%2BXtrgUh%2Ba6G49k4RgevjfavNkv7%2FZJC46b%2FqZz6krE%2BNkV90W0ceC%2BERvjf0oiiEbH20YyGavKDreU9tahMyrgrZpKE2aB7Z7IgGbbfpvvkt8KjUxuJkOnwigHMAKEWLT%2FaW14rf5bqjIkfnIK6pCUwozTPG1Me1l%2FGD1KTPnNPLbUMJTUQh%2B0RuHg6o%2BXGTYNs%2FxCcCn8AavCNuWEutAozUQLsQNFeICT3po7lXWRZFGA2uoUCraaWvOIBgH%2BAbVjlYY5nodMr8WvfHcoR5tT7XsmicWxWfokJhqsX4eyk991Y5YsywAPxL6o3Pw6y778wWdJjxSF6GI2YOGMQHz0mb7u8T4xy3rnKv0Quo4b8x7I3jXzLLlWNLBmDoIRa5pq7V0YflVZVQ1L6r4y2N3r4zxhDF7Viend5fH%2FxshbGO%2BADlto6gt67CzjChOkMmv%2BOPiQp03JN4JJBOBWvGBS7fqMm8z%2F8imz67JoG%2Bw2aTZvbIPm6mra9cWOLMLZ1ZtaIVgKrNMdEcaoE2P9JgW7g2QTTQDm1CygOz4D7mMVusEJ7r08Q8BTonOsb4l8u8NE9MmjWFwDGVn7jOB%2BjdLWeorlG3nqyTh2shTiu3aN2iHNL%2FRolxg204URuoJuq2XyvJ65GX1H1QUN8nq8e0g4iqvHYizcntImgTXj52B3cKxoFthsy13LfUaJFA1%2Ft9mo2kZB6wVA6VaSbprViiF7U3mATF9dYrlJsxpCz3A4xIkHr9JwZgmv8Z6%2BUPgkDU45%2FnHgjJainpNIcDu8uYmJRzpDo5YXEJOkWbXyjXHWXztTxlSzCGXikqugDRFBFq9VeLTF%2BmjjwiHJimrYMx5pjtlEr6%2B4FX278gKmwER2F5u7YfiffevRrUNXMjuJIltLWbJzUYhDx3BWSQvj5i%2Fa2O6vzfBt9SO6g6DoF1jRtkJsInbVJHGebT8EwALFebsZIr0FY3A0uzJyvcc5OLny0aQNkVbHaEoacH8%2F7iovgBMUHy9xFrNgFeDRdJGH%2BVgan6dcIhscaUWAkcFdmITJcGvTx39FbCa0MI%2Bic31E8g2cd1e8vbbPxlKGfvscyss6eZQpirBCIr9XV%2BEOa38qKsMMyxMLx%2BmVuTzj4e1z0a07t5nQRPGzda8jrYxHfMkWVckWC625Oz3Ov2%2FDqIE4zx2ifj9fTtJZ0jMUqdzLxZDTC9PoYg7Lw1IsbPV8BaQvnTg7V1Ps1EBmW%2BeJGk0j%2FQQnvUsBeNNgxwrAVfNRNxjo27oVfss8USgXdxawuDgxDQLAgy1dZPBykLpxXdHbjU39DQN1b2W%2B27y0a3h3ARwRTnhw4PfdgM9XdbmlZGbR5Yp0aAo%2BodSMtbUVuxHEBfvaERHVHic4GWrsSZwBOfWEDC0d0LvqBTQklkcGkpBvMgtpKxu96LhRO2kZVb6p81LvGzcnTVaRZz6Of9jeVYSFAshIbzOXERQP12qIHJO0mqJuIetuCsqWUPSHTc75EyLIMD5JT6xmAEh4RFFQUMXluC0GWOsmyDZXcjKSsd70H6oowh7kW73XuRbTIQPggoV8uMP36JFPGp3RHSwYcglVsemdePlkYgPH3rxxE5XSjmiv6BwW3ceshvfSJ52lsyltBlZGpDusR4IjwfN7U%2FX2YLYIvZQICz10XcTH%2BcakUYg6gg3I%2FXErbL8on05UQs43EhLmMdWmaF6xm%2FmZrFsPyB%2BceKU6Dm6oI3Acdk4idRTf%2FRk2cDdylyuHsvi0rCXQviGFyhSSI9xyjEKRJbXPunsp01TsgUCSqRaVAz12p6p4fiY7mRK%2FPmFOsprMyXkaj8RHNuL9lDHDqWnFWc9OHjfDpks71WACfQzub5tSyZThIH4Q%2BWNR%2BBnT%2FWXvnRAI6H4BbUuwEJLHFjl8B29h%2BMM47ZVYPmLv54sg8kKofmImpBiC7bYijGrdHlq%2Buf8LUmDv51N1710wLOaER4q6P9hVzLBg7rbzxioYYOWONnrjNdJn4tRj%2Bkzhhwr8yxTi5iGi04aBISewg6Vo%2B2REcHg04YtexShtSFf7qgQTwhkwaDrzT1Ml5QbwxILadeCF36Fn3AWYPZSg53xhkErdybX0S9IFykJa1WlpQZ5qWTNaluVGpWhrxFeTryAvFWmyY9BS2KB%2B%2FMpmiSt3JR%2B1rsVgxy29Is5rKTsa70r9HZG4YBTiMrbLFLk9mr2LxkdC9Jnuph%2Fzadd6CSVA9EVi%2BQ2VMJQ0mcLFK7BqQPTmjhhnuKJfNUubOiDQAwwZztJWewnTXBhL2EV74bFQIcgh%2Bx7Y2nyHdGNJ%2F0WJKa07C%2BRFu0RUT9tjn%2BrRAsrR1PKZ2X7hUJSkY0hUlnUjBuiCBTXaiprIkLjQnpbCVK6vy7Op9YjVbWKGnoHRYLodeGjajMPuJMapnmCQs7M5y87PWM5NOSiOJzmNZGoEHbmWXtRZFuzaqF6jWh52gL1nRC3hWOut7O7i8DcDjlIl2734%2F44T2EwBZ0W8kJ%2B68a7zxa59L0KV0NhGmvfO42ubMqAMlOlUBp%2FeIHvFjHh%2FzdFBl36sQB8VWMVhiR4nrOZ7yaga4x4r3j4UGE3tyjKpswD%2FVuQBVBmbfLjNFxWSVnm5wXMFXQ%2BtaUcRAWkW%2BTtWm%2BrBqBBwNjUOdYRQnESuDAjdO6O9HFuElF1GWDpZf2%2Fd0sJweu5wuukR2AI%2FqzTGHvvu33iact5Cxdjk39r6koIuv5ngfCP0X%2BxoraLZ7vwr7Whob7RLjA0CIyI%2ByHqRqP%2FUBG6L2Dui1Fcoh2R2pydrloTfp2MH0G1WGe%2B%2FxYqR2Tcso1x%2FsbxfC9s6A%2FAwqdK9xDUftElMqqoddldayB3bcVMF365CmGvFUTWTfYQSDuXo5sFgltvyztVupDrWg4SP95pCgzy3CxfacHSrZY8ZQEWEz2J3Yj6X1iT1lynLpb%2Bnts7zquRqxFKaA1%2Bgw0eXqgpeMmcemC55BtqNXskDyfktAsDxzI0dAqoQ%2Ba8f4vbKPtpDq0pd4%2BwdWiHKdDtkYy7LSvtEvC2iT%2BEUMy7SMwvSSbJJLzaj2BCVN6EK%2BvmqbCXmSt6A3xsXLtWTQtyCrugSbMZUpDS8eEWkF9LsrbGvAPlEV0FkU5IeO25f5FdTfQx7BJEuJNSxORGokhT%2B%2Fvzi6kXqNOwXtYGGEvzvntrC5hcHirFC1QlsiIDlQnmLYOSX8mgsO6qOlDy92AcLoS0h%2Fb%2Fy1GFHGu8gU147GVm9n9d84ZhUUt4U81V7OJdOCR9AUTca47V6aDPSYb8oKsU35GZ%2F4mzcfxtSr5dzjaW7lGNSfIIAmVVrTxwVirsZ8pkIg266AJksAXzwHN3PatJ84mtYG3LBxKQoHIhueTNm3wdcuAk3Vb7uNuo2PXynWDfgIIpEVZKTUFQlXcjfWGQSdff02NvGD1WfLy1Q9cLatpUX9Odh%2B3f9qoos2RQKt3oueoupP9pQniyMQAKIYCyyEps%2Fo9Sp%2F6aRUiTkgKniGMBbwe3H4cig0zf26V%2FgKCNCk56QPmU9jHVYBIIK6rgihUq1jl5SzhooKXQFWgMhLL%2F0q1CN5J6Ioqj5e%2B3S8d%2FaZm%2FLiVSYS7rV6B4vcaJ%2BFR4yANPEP9JqECrQq3DjjVsofClHTUfVZimyCMCwR9EZr43K9tqvltvjwRMnPTmWiAdwocvEnQkRiVLynpXl2BOd6ENyJQfiz52VTo%2FFKg%2FfD6b6ykMTSu%2BmgbmoDGnWxcNQvJ%2F%2BIjTnbb8ktXglaxnZxoXruiGUoezG61v6IvP%2FEiRGn07eBBvsiGz2%2FS2QGwBiedOpmr%2FyIgJQOunztzNj8C%2FrekFnJ%2BECvFEPmwUsePEvZVu%2FI%2BNdTD7edfYTZaiGzxYsNPmAynFsCLLH2OGd1rb8UFlUUvglErfqTdUZAg0IpXnBxFBWoqlPxxJrzMSQ1PP0aoLMSxQ4EtABFZAC5Mg9tR%2BqWsqmj6686c0395tnQOhz47aNDm2rnDq%2BPt0vkjsKuNaxSo8Ad735BgGp2euu8z4S8XcVhGdkULPeJLYT8HzxzDWar96t6onTYISz%2Bwao1HMvLi2rblOMr3L9Np1FrDPIHQc4ACIV4T3maFnAZXDm9r%2FKjjgGtaWKt8o8PBo2ElB0qthM%2BYEzP09%2BG5cXxP7P%2Bnalmt7MogBd3C8jfr8hCKcJDLTdDCFcENg6QAD7eGJyQLBrYh0i3NZC%2BtO6XLU7H6X5DBjRB%2B98E39BX6GiSxaLFzIiCIXLElfQtbjus6ea%2FMGNZIKeHjO%2BQUiqZzJJoG03edx5iO7w6Eq83vmyUFdGYphwZzO4F7SaYpU%2FG0iuR2hoWVBKYFrEVUlmoi3%2BHqLMTw98OMKXcatlQftrk5EYO8mS1hRh4qz%2BeiUc0Zwd0HGavUayN2QfubSJ8pS1XqF84D2Yv4zr7Mv8w8c6mOiSoDo1e%2Fnylt5mIhMnfps8r2iwA2ryM65mYZOVlyXfh6AggJW4S0et0xHAgvSjku12INwjQYirHJNL5l%2Fh%2B94b%2BU3hNGIvvUq58p7FaC1WJ1GRXPNnW1FD5pkrQPxnJoA%2BjdMdkgaF7QiSrDhV1M2IKotvo3d7C5nl7ZaD%2B%2BuDKp4dH8uVVlxxtkOoLXH7swAfpGjw0oc9SWaLhcT%2B7zDadZTgDr2q9jna2sWR0JaHoPwKPGuMz0NBgnXwP6EbEPZvo%2F%2FBVe6gZBY0SHeaxDTdDdkE9BGmCaL8oSYmxPtt37fFddMEpAI68S5x6tDh2PFmqMLNA0FumyWkB1312ypJTA%2BbJbI3LpEFBKwTSLeLwRTG118p1Izay4FIZbjR8pBSp8zLZvinMxNC9cVQYuEaYx9EKCPOQto6fYxb3B58hLYYoXMFvLcDI7Sk2KUgjX8qEl8ypSs1qm%2B5Brr00GV4hvqCCLIkaCAW%2BwQVxPI8HM%2FLpJQY6pGhbbGh9J6%2FyYBovZbcp7KYIeMpUqtCx5dHQ1GN8U4kKinAk8LZTeg4zhoOVXGCdbpUJJKWItATXYfKbhhDQXn543%2Bvab9C6HtQUEyXiUO8s%2BHlZ2HwVdls7vMIprV%2BTIrVh1wotV3xSk%2BzmR2zZhVUQaK7ut6hhl5SSsQBA89eLFT0RxmxPrkNVMHKgYQb%2FUiOPJWbpMcvS6D3ZHWNLIqSIYfuElqKKdPKV4cNpISuan0mAH1Yh%2BYAXAYSi0CxvBr9mFbvTOx2M%2BuWgiMVaykN%2BEZ1%2BWIW15fQpXxrLrIKVdjB6%2B9%2BZxATH4%2BxmWbyQNCFT%2BF69mQHEv3JBXnrauqLNSFiOTMQ0OTtB6%2BVA%2FZzlQ78ouTT98ml2B%2FIr0X%2BPTd1opIxuQVM7MS7IcIfO%2BxpnLOYLANbg4oyIlU4qL6%2BM%2BLc5dkGGypNFv6RN7KE9nZA4TthDI2zWWPbbbbIgAo4Kx5uu%2FTBzmu40Vm1g9gdcxUeT08kV1fkQuEBb%2BUU%2BPh5TgG2J7I1I24ktIw3obmzORs1Y6JGyCgEBDEvG%2FfhbvgXeRDa8oXQEmw%2BlWi%2BOuO1LOlVQbzmImOAp0rt3ewxQ8pa88PdVq2Pjx%2BAvnHAKgbFKmRAe2bXxjG6KfxUUk4%2BA1Lp89JeDwsg0mr4DXWQiopG0FCZrWrQ4C1ht7LdFN0kw4XxK2zeYWxpPDz3dH8dUHq3qOxqhi9rGvOeq2WwTSQqQYGya%2FZx5Gw2u7poxd5GdNGgF5jLbu21TgHutlGQVdV6LJdSUER8XBfA7lGjnaD2QPszsP7FT4ddGGra8K2CKLF5fm1udJqECpqfYYbudvBVnYyNqTquU0OImIrqUeJHiFNJpIBJQfMx8JKUByG%2FLC07y9fv41dDSXrFQ9tP1ngRm2bdZGnGS8%2BXk4NJSh96%2BtHLBUdRiYdqQLNmc3lNSWjRW7%2FWsaUMacbA5wCyOkChUG2hK%2BY3cNyT9%2FGiXB0kVFRcBvSa8bn7iGQR1bVTHA8EOoRi8cH1h5UkX2coKG916Ji%2BB04y8l%2BBMUUFnEgfUZR2bBkB%2BFOqZNrHBLomMWeVNLvOHC4jF7rpnbf6SBAvwTnWZ1ybkznj0qGGB%2FnuTWGW1h%2FP2qBLXhIIUYRAkDBMiAk2YuB2CloVuwqWLwxcHBHzQu67IyPkKuRohZpcxg2tH7gYvNt03m3Wb1k8Odj91rIYgNgjiAu4MQySm6lE7B0kDR9ucak44Sl4kh6QLY7CqvptPzVaaFLZZhGrAVjw2WV%2BsNjqHPkiwOjgps%2FatfrxANs145tt4WxyTKRULlcq3vtlyGo8vJJ3VEmFAQYFp1C8PJxlDZheaJJtSoBCvjDRljZ5rLMt1HPcJgFLtCs5sIxcsqdHHRUnfc%2FwxAGMs69E2Tito8%2FrHaF2BS4jiYkrRTK9oxE3UeIHqd2BoVgz2pj%2ByXN3Hp%2FmIF9EUF0tvT4S9Qz8rVJObqTUFNV9grsk%2BW7XZaL8IFPOg0lw%2FS%2FIi1VVy4DjWC768YO1e5PmmTOd894DZzt%2FjJDx1B9H%2BN6jj5zjXCEokWG4K3Za41YdX7%2Fwvf6hGjnBiIhas8JeCkJCOakONG16Ke6rkXpwqjPpjlhSYPBbYV7UCwEsDWRVh5vXAgwTBAZ3ZooJE7A7CS%2BYN1%2FHrzIRz7kDPNqA55ve5pEPrsaK7XoBdD8jp84Tk6gUlr7aaYOEdHWMFDaIPKJgGWdASSFwzBs%2FRlFKxkIu61PNKtCKvMnoI7lPWHYKJadoSSZ90s7f4FmGDaf8E3dEjJHVTtOKSgfCGKEuFAwXN1k1ojvZE5nQyzwk6JP3vI2Wvlx5wVV9HaJcpFSokjNsQ0W0T%2FmzTuINTzu6TEUmBPJa4SdtWWWoAP%2FSjs1UPeg%2B8q5fY2v%2BmT1ww03nozRQTBxGPlAj8lXhi9VqUWvlAmq7dCobi2ViSvkOvox08UpYppmPC042eNQHXPk6%2FPYxFZi77zdH2WRYOC5ZG1ckdtP2uAVOhA2P5fb7nGpN9U05dA2kBNNOW9%2Bb9mgKzEzbSckMHp1z6SgL%2FdCq%2FrnzBznU5VslEJrGH9kdBYEIQDMLy6MNBfMq1l%2F401G7KV3%2F6U8dhdImNtPIE6f5h%2FSP8Kanhcoz%2B2z%2F3ewu%2Fm3SWYKR3Nn4qmt70NBAUkKaQ6NRg3qglnEr8IHDcAZrrkUeSo5lN%2FzYiUjWbAk0hFy6mfseuNHkNhj06JzfxeO%2BGc6kUSP8giadjQST5wvWF%2FvNFJT5jlHHd%2FGKbtnI1qYGm9n3kS%2FXYVx4b%2BvaC4inYxzHSQzcjWyK32uCDrEeSZP%2BzCHdseMYfHyDafxqKrXsIU6KB7slmfQic7rtds9XjnjoO2wVHFIDceEIIllfrytpn00hZR%2BVognIFXUW9n0hPjhQKje9WghlL07w5wdhnl6PGkIPbvawxCz0djdnZQf62oossyYWnj6hQthH1X1XbwtawJiyhXFvazwQ%2BybQnMK25LQkogaJRXlEKe5L5H1vXpIBM6ZRoWx%2B5byVNrXpXV46%2F%2FUzaFP0sZYs0nD07xywKj2u5woY7vGrBkGNi8g8dZgXdyUDD8XNxpq8l1H4rf1s7ceKFZ0poskateTu3hq2Uvq7w1pjDDfSfLmEh%2Bif%2F3T9AbPbvxWHy0FA%2FGvYVX%2FNC0kIOfUUTYG40x0bzbivap8ibx8XclWicJfANqKKuldg1pn8%2FnuPjJRBNv1qGuaQnD5j6x1X1HKeqCiVcttFjEozgAnsz0LfzI77nnote%2FezEa7M7J4KFGWD32GdC1t5TyWDeA15z%2By6fDuBYqHJITvXwz0xUf79GQYJFv44UBZABaftXbIcuJgK96ngCWrbb%2FqG%2BDAYZGh6Fg7VYkRQbjFVJ3g34UJnJF23FDLToR8IAtCbLxG5XO%2BxbL2MH%2FNi%2FlpQ1SZqoss8MmBmoKklcZEEpTeNrLJluFFk6V1aDzpkLQ3briWJfkteXKphURDrO570RrLBcidOrL6rl5NVRVwzH8iyInDFCr1STYnz4oYEJHcj44b8Qzqq%2FKr0Jua1ZcbyT7%2B51xm7ygHh9L0W6gvSLo3XZeAK%2BXKb1GIkpY7V4pPKhNIDiOW%2FOSPCmxWFFfUhDVSOeRznLfPBN0HthWoQr5STRXTZyUMsEy3ZSCBztusIdQCPVNviBlmd0d94KjbesIdu1oSIsk8f1CZvFo8E0rXNgs0TXDg6IZDtUJp3g9D7LEI2wB%2Fl1ySVcxo2G3QCYA%2Fd3JXwnRG%2BKde0y1%2Bi10FEkLPlWOEZGkFOmeDufqfcc%2Fg7gS5Tso%2B%2BYTw9YBVrCiHzt3AVeDkwiQMAwZI4v0Lu9HUyIC6BTDh%2F6cFrwChRrNnEWV9s911bHdgZGidDW6Q%2FAIj7THgyJBJkB0oxkMSRVY68862oLiRp9yWKvpd7niABG8jCOZ%2FL2TgCu%2FkRPQtTHu1ckGZvfQivphc%2B4uq%2FzNaNBejuU8Lun02jAYqXJbcto84pIj0PzfQEvIftDsm4rEgfr0dYPHwLupE4ZoS0eYYjZNQ%2BbgwBlt4O5V2sTHaSFV7avqNPJuIDZXUHCIm2ApevPtvVk37DFJ%2FHDT9cYlZSQK9P1EjHvTZblbyNgo1zKcvjYvtif4o7e9rO5jKAXrQxPgXIjMRYfb%2F1lfrO3R%2FOjTX2Ei1UfaMJ%2BTnI%2BVlFtfQ2EpHRRw33UQ9W5SMf6uJFKh%2FtOvOdlkqoHp2fkSlCAUc1x7o5M76ScJ%2B37x4sf3buDd1Y5GOadhYj9jtMwXVwWJ4XD2gvsSjN06jdEfeurAG3bggPLHzdR0gxznO8NGjSGcN6QzAMSvk6nfMsa03QFEl5sjgEAF87Yl8KpaWkQ0FpuwmKId6sKSBDoWtaPP%2FjA%2F4cyFIH8ziKL5N%2FEX6pilKec2rRzeTQTVl%2FWDGzFrDxJnZQ7Xe2rdTCXiENiI2rNmvUtt5ChzVD0TfNN0iGXK8mjX6J1ERPWIwIMHXh2V2CZJQb5eNF7XJaFeFw9Xei2EgPDxKFkUbr6GdW0cU%2FZM61SBg2dmw838%2FxbhavS%2BVnHwShS6B%2F%2BZb9GHsn33VhJGbLhVyBpD7BIiQBTYZw5VYUDlJeU%2BiuVZzpj34J8gXHlCONF8q0yjXKcT80QeuMES1j2RtudVM3AwgdrZNE04qbG9PBdRCRhR168FpCEwY6I%2B3zdyEKPPzBE0g5GdFaFKpGcuRM1f3kkzDGzMvrYUAPwaWADvDfHiwyIY6DX8upqorgsSuPwXF9P7sN%2BCL7kk4n1cokOX9ZUrDrxpS0Nr3cXH6vBMjRb6vZypRPXpWH6Zb2coeNPzaFVQRa3BpSSsgqtLeNAAmj7stpINxzsj2nKEtr%2FqpOlFRG4iF3ez02DOWiwo2yMlxlkVl6ws%2B%2FRg5thrvGuhwDDWOAbBscejZTiUYMkRQ4G9orN%2FTSpoEIP7WjDb5pZqWpDeEakccBXoL6%2FCWULKCYYxEdxG7QemH2LRCEzIUNfksqIAcXwK0oTaa17YFZT7F5GObMCP%2B0%2FER2dJCDU98j5NVSU6SenmZdwM763HxaA7dfmdsMgyUiufXCjHugYCViIfCZxJwlnNCK6Gt9ZmcatnlVhKZ9nIP2hvk5PYzj4y%2BlCbJ8SnuyjFgoyhEcTVrQ7ZtqeHP35FCY%2FD7QDpZayDjPvEr2ro%2FOfYvrvipCYLPrHf60dkzhqyUhH6%2FhJQ3xR6FCwsD0cXP01OYOEqfIkii7bn3LUPhghT3Dm7kMHAipcGw371azX%2FI9TbLbC%2B0JJoG7msifxjRkVb1rnL9MDedngVHqkg3xtJUzQ2BqNqYEnzoBKiwB62t2Ogvcc%2F8TzrzXotdOqFxXFa7f9lSbMdClbjFDKL7u253h75pui81%2BlixGjWPkrBKzxjHRH0fMDs9TbuALWeTmyhenzgampSEi1IdWE8yGhJjoqpqZqz4NimfBoaqNzPyqAIZK0OF2SzGyYc%2Brr1b1mqoRoSPJsYlVuA2g1ZqFtC6Cz4NqLmBdfyoegWNr3909IR6ZruXiy%2FqdS%2FxpuXWedGtcMaHjRDwgCzDJ1ViRdZwKmaTdCoG22NnABy3br7s6eZuSt5%2FUC1Q5Z4ft5A5PP8P5eyWXPK%2Fcmd8u6ANIgBbcnEe0c46PUqw8Y%2B%2FnKJ0AUJ7mkMK6HN7yiEXTV3ut2NHzzNw%2Fj4Mvn6tAAHcp2IhHT%2B%2Be4DU5dmV3FMtCPNlI11jeH0%2BCBGSeDNIY%2FM3vIuM9oruSvcqOx2R4Gu%2B%2BXK9j8J7Ir%2FkM4hwOSPFcOpKArXEoRknJiN%2BT1JGXCjVdodvI7tWDLPwrWyDxI3%2FqzkdA9wFEzhYkDLAzJfHXXDzSWH%2Fe0MHHZpLG0PTA7MYWv%2BHLLlh3j4Eis0kjxBGKBxQACLAYsLMMcrG02mcRB8%2FB9qycThmG7Rhyepc8bMXXU7mDeJhWzkdSXNl5bKU7teQqIY9p%2B8e6WY9s43Ri%2BEcS219u4h6eA9Mf6vxDzgrf36TgYy6iJ%2BCXPS5LJNxT8QBJVBc29WSYotVA0JX0Edvhj1eepko%2FyrNBNjtopR7b9DIVPbcokBlMAycnGwyP%2Bboh9P579nokYsblpCGfVG0mV3ky71z%2B1PnxTr3i5nSHSPvzcLaKUI2JDCX7q%2Fbl2HMI3x2Yhq6Yr9%2FZkvghoh1FywcGrcu%2BpzYn8vp97U7fTzJDJPsf4eE7T5nZa3MGTVJr%2F2d%2B5qqhwlI29qFUFPkDunrdatALnNGK%2BeGW3HHZ1EGFTGaNnuJl0cGSTv2uCHRGHHVi%2ByPAw1VCU6uMM7d%2BQFNqcCSo9nuMJwL92Map8mzIU7W%2BXlWxUPoDanS7jBXSyWXOneAhj%2BCO4IY7tWqUHDXPCOXjodSJCkqXYQ3p6y3DtKWDn2BpvecD9JtJGImv%2BsKPmNMTA8jqQ%2Fb7EamEEKcJpZircsmAUE8D8qbeParNPHkmRdU73IZweSn%2BFKW%2BU1PKNEdyCJMkCYWtCeevS4BpbOG3StFtu53yvIE%2B1H2EBFC8rn9tGT5aAlJM4x5V5iWeLfuZI7q5a9JpqPesMP1XffzUDJPHnZM6IMxLWvW5slXBeTk3mhaHttxRSpBy4DaxeHqoH%2BrCtDOr8em2V%2BiI5w%2Bi4gZVubhcpfbhZ9WrdAb6erNoll9VaMEEMwfuD5dFCshlWtKiqEkEHJc0redkpe%2F%2FR3i1O4U3iIW71JLlMU8LnktK4GRtYCWPsRGROrFzHCKuiFuKdqaS2UW2fAp%2FtGEFqJ1MyBCsqhQ%2FjHG52exj1UBqXyMGlW64oaVLWzJNbf90P3dlmSfDkUYqnDguBdrP0JQ3B8LWzV6JTKpIDdvSuJVSKfpgyKnJ%2BP%2BU0nYykonn1VfZOw%2BQDnvbkScngnUseCDySKI0Z1IVeyTtnE7EC%2FqYyU8Shpqk2wlPItOFs5ZZNMd4NwlTk6KtGOWoaer0U3a7e5BL%2BaJIyjt5RxiB%2F0vL%2B1RHqGukyZcc00keuHZjjus6WdqApsKmhDxJpDt%2BAQGDXtRuwcBL5cuMuIZOSRFgNucDxZPvTJiFYOcNDd0bjiyvn2L3F%2FyPsWfTKIUaR3ybmq382Tmm3BJatzL87IiMfqwYCc3%2F45XPaC%2B7JRlnkZhyb1a9BJq35X8nGD58Z8vsgjDy%2FoJJom1fX8ETdw%2FMBY06jDriW4fT6%2F%2B1%2FUDOgjLXFO%2F25GSfiA6e%2FN6nCT0I8SY2VljD7LGq%2BFBotGn0n1ELVeQ3GQ9%2Foa1d5BlCDHoYn5Hiu8hf87AiYPR34H%2Ffd%2BSIbbZVZilYODnWYQbFVJiqlMOOqzWLWcHZPEJa3nhlIzUW0NGTREYTGkbAoymALUZWiJ9WSPZWct1FSVv%2BLWtf%2Fetf%2BwIVqm4a1P8j%2Fo%2BM%2FnpdlNTMRpW9k6l3zR55YuqsfYPral3zmpfm6uJZ%2BYp4P7NIkdUoqhaUW2E3PY9Bb%2F5IxMOmIOu9ySn9fNgjYSfRhrefxajXqzWiNf2U8hQo8ne9TUqYvK6%2B%2FA6FVjRQyE8i3GcsG0SUcRfOODXSfVgEwqY7%2Fd3x3ohMKDVSOqbqt8TEfO1wQHX0hfuyD41peL4KUpg6FBL%2BEBepSMA4YZ%2FMQZ7i3u3IkZhh6zKDTyLqdY8h5U8Rz4Y5TvPVxmA89itCY2Q09mnpCZZNBFW%2F82ht8%2BZNM%2FjQlzWjytSMp84pRq8oyvkHRUasacUlQ7BoJLI1mMWEY7JsgcVlgq1g9n661vkcll%2BvHY%2FIid4GE4a3sYq3eqGSXGqdeBZ4aPK5rTViE2Dugo7PLBwpEzmbvroO1kT2k0auOUGg9UdMXDUWKPq3qyhplsREBO3BZOLJFenviu0uCyWqa1SmRszNhGhutk6buZ9G6vhLE6GjMWCroZ2EZC6gKAdeGxSJoPWem6mgldPxtTRmIEQi8KM56J%2FyL7HzRu1aTGMFjG6i3gLEr%2Be7FOTsmtFZX8ezHBmU9YrY8O0TPEX%2FDOB4m0LRVkT8KeRyU7jPaVFUM4utzFbMNjzVgqhSopQMoWPGPBREo3yYYgmp%2BtLysLGBiNtLmeGiCae4iCweSXtyLjnFD05%2BfZlmg6nAiaBze4ucDZ4jquJwM4cDV0tWXaBa1rCkQlm5F5La07tjCkJWSxJ6czFkyIoShXvbypUlGFG1fT1hqqnSn%2FwZ6XjwEyua6M9z44ZfD9tykZHwBBSBO4c3CMow5c9M8bbk9ReylJ5gjLE0HCnbHHIuCCRmhtwFxChvWcamO1ahkwb1nLhZEw9eUE4NCJZ7eZc7vI9ay9pr%2BOYBrppyhXdd5KppEFyxaOSeg6DuNgDLelKNTNN9AM2e%2F69FheQ%2B%2BALQPlEfODcWXlH71CeD2clG3oFo9WCHDkC6LFKyMB0qhEbDWtr9ckdHogqAjI2ilCEtHTpQ%2FBJHVPALU3FCb7UaEl3uKKpBcGdnCOaqh3i6XeWzi09IRt0zrvpi%2B01ZM6qAKDpFuZjNRpSBQ1zoIqUHcYzJ2Zbr%2FZcBSNME771CViXx6VTE6hbbpVcPDtnPOTByvzrf4VOc37lPY0UQHwyTUDPw42gp6%2FJXv2CpbphklcWZsVhOzmu9qtO5HHf9%2F2Y3Sv7msEAqneou0LrI4oZWvBLWqHCDd6uil2RnyK9m6IryhEBX4IOMXCQiIRrzV4DY6vjabtMY81MeZJs%2FAQ9A1HzDrmbYKpR4Q3ChVdUl3z0TUwlA1DX67t1%2FMyfBIGwKel6GOEnm3dIccNNXwrBSqADQTjz00MRZfnkq3DbfuEOf3Z0aVzoWe786QgDYnHc2HfxFdf%2FWOsXjMVPgGYOiJX7hDJ2NNjuO0RuvE%2Fd5%2FFkf2FqmrsYkpYhkn6aSgJJwLvm7NfEkrrB3XbtBw6AUKeVdG1s9pDDK15iIj2PdU9tC6WrxL%2F51WzK74HwlSpdRYoSiyt2kMbWreE5pND7pV08cniD5VdkkqvaLQbcIJurealsNZoS%2FMIrKfkkK302SWvRL6AmmipWoj1viI4U7Md4R5jTpRt05PjnxllMrpzd4%2BgvmHZMaqe1vYEI3kE%2FJGPBx9DDiiXhPdHbek80rc12NSJOHJalf8%2F%2BANVnkdTIkBu2yGcuLeZ8OAs%2BnYn7sVIDsydIKd3jxxr%2Bs%2F0zasWxB3bEK58DIMQeyxqAFggZrwEXFjISYCMROBgrSPMPNrNh9XzIWAeWYrCq%2BSHmTrAeMvVxz6fHc2%2BfHS67qrj1aMnXjxBtglXrwNWZj9SIXF3Vg58FVqzSXP6M%2BIk5mp9G7FNu6RLnUeZp%2F%2FbBVdaJ5RM4hn0mltQyAO%2FIGWmt2vmuTiiGf2iSAl%2BCSQ%2F%2F3nF1bEaOF%2BfkCjtabPE4lOayHEtD%2BK0hudz2X438eCVFNV18SYwnNectsLeox53XNOK7jQ%2B74xsrcD8q6D%2FsOwbGy6LwyB6DWVi4erDU1MoYdaZ2p3lr2afXCcj3Ige2IJSBkloNuq%2B3doof2X1rnvh5K4y3bf9tSrwqZRic27YjJu08l30xFOf6roLbskapGTLcXbsuUVSUcI6GH9VH0sLEbCObVtTFVTrnt3zhO6MZTX5WJV2jj6v5Ahe%2BwlHwA7ZmMkimrF2pWqd4uZ8%2FesJvYOsrZ%2FbMBhuBmag76%2BoTcR%2BQyQxPEAcpBN6fE8avySJ9klkO14yojXpHr2ozVwbTZJ4Nf47ae%2Be6P7v1kua%2Fzt7d2PbQBs3m7dB1AJZTgo2iO45Sff3jWIt7Mqt%2Bc1OErkq1sWbLs0krDsnt8ROE%2BDNW5EX%2FWDWWARoq8RcXg2JiTZCwVpbD8M8S6sT5vAGGZFtBEli6FxyFnSFbokraL4juWBr9%2F%2FJb9lqrU91vNdclw2kj07nEnf%2BuXOIdkq5laeAMfQfcXTfgJyABbzg%2B4dKmDNcD1h6auq2lWSufpqC%2Fj3JpZRJJV2FK%2FfXaCGNtGeGFt1%2Bvbrdm4luNVBivktNsQSwyqWnuOlgB%2Bky4cjjySZakKD38Sh3Q94WGoyVoS8OzGuCl5JOzgWRR7LsbUGyPrcaKLVCWkbdnYTgXeUCb5Xx7bOxDtvyFkRP%2FvNqXlkBiJnLf84Mhh0quAp3Bez4%2FBrHQPqyr%2BGzuklq2Gl0ko4%2Fo29pC8QtdsDwNjwtgYuHsxtM%2F%2Fu0ff6s339ScWUJJ8EmWoD%2FCVd3vabpc4JGXvtMZT1%2BUjb0zfvEd5qLrtOi1zS51j4HTmuj3rVpL3qd%2B1blP2nZGlCFqa7SMJsmq69VmRmvj%2FjiuLiXfqWQq3EZOPLnbSaFYrZ%2BagIcRrUKkahyDUeQ6m213El7OD7m4gNBBEQr7HFX3nI6O1FUBxN9Aq010A0c%2BOxmzPyQHb%2FuFBWG9y2LggFpSvoyL%2F6cktxRS%2BcgMQEhIa60GwmIKiRk17hB6eet1SM8HCD6NYN8A%2FlYkVF1qIhsxIZ3g8HGvW7%2BIn%2BSjIhhb682QdoxWt2efKGkJkebH3Ugde6W1Pe5UuyaxzsE%3D&__VIEWSTATEGENERATOR=2E2252AF&__EVENTTARGET=ctl00%24ContentPlaceHolder1%24ctl03%24pager2&__ASYNCPOST=true&__EVENTARGUMENT=";
    List<StockHistory> result = new ArrayList<>();
    for (int page = 1; page <= TOTAL_PAGE; page++) {
      try {
        Connection connection =
            Jsoup.connect(url)
                .header("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8")
                .requestBody(request.replace("{STOCK_CODE}",code) + page)
                .ignoreContentType(true)
                .method(Connection.Method.POST);

        Document response = connection.execute().parse();
        Element bodyHTML = response.body();
        Element tableHTML = bodyHTML.getElementById("GirdTable");
        if(Objects.isNull(tableHTML)){
          tableHTML = bodyHTML.getElementById("GirdTable2");
        }

        Elements allTr = tableHTML.select("tr");

        List<Element> elements = stockFilter.filter(allTr);
        List<StockHistory> stockHistories = MapperUtils.mapperToStockHistory(elements, code);
        result.addAll(stockHistories);
      } catch (Exception e) {
        log.error("Exception getStockHistory {}",e);
      }
    }
    return result;
  }
}
